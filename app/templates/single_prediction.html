<!-- app/templates/single_prediction.html -->
{% extends "base.html" %}

{% block title %}Advanced Transaction Check - Hybrid Fraud Detection{% endblock %}

{% block extra_css %}
<style>
    .prediction-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .form-container {
        background: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .form-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .form-header h2 {
        color: #333;
        font-size: 2.2em;
        margin-bottom: 10px;
        font-weight: 700;
    }
    
    .form-header p {
        color: #666;
        font-size: 1.1em;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 0.95em;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
    }
    
    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 30px;
    }
    
    .result-card {
        background: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 30px;
        display: none;
    }
    
    .result-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .result-header h3 {
        color: #333;
        font-size: 1.8em;
        margin-bottom: 10px;
        font-weight: 700;
    }
    
    .prediction-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: rgba(248, 249, 250, 0.8);
        padding: 25px;
        border-radius: 10px;
        text-align: center;
        border-left: 4px solid #667eea;
    }
    
    .summary-card h4 {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .summary-value {
        font-size: 2em;
        font-weight: 700;
        color: #333;
    }
    
    .summary-value.fraud {
        color: #e74c3c;
    }
    
    .summary-value.safe {
        color: #27ae60;
    }
    
    .probability-display {
        background: rgba(248, 249, 250, 0.8);
        padding: 25px;
        border-radius: 10px;
        margin: 20px 0;
    }
    
    .probability-display h4 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2em;
    }
    
    .probability-bar {
        height: 25px;
        background: linear-gradient(90deg, #e8f5e8, #fff3cd, #f8d7da);
        border-radius: 12px;
        margin: 15px 0;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .probability-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
        transition: width 0.8s ease;
        border-radius: 12px;
    }
    
    .probability-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 0.9em;
        color: #666;
    }
    
    .alert-card {
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid;
    }
    
    .alert-card.fraud {
        background: rgba(231, 76, 60, 0.1);
        border-left-color: #e74c3c;
        color: #721c24;
    }
    
    .alert-card.safe {
        background: rgba(39, 174, 96, 0.1);
        border-left-color: #27ae60;
        color: #155724;
    }
    
    .alert-card h4 {
        margin-bottom: 10px;
        font-size: 1.2em;
    }
    
    .model-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .model-card {
        background: rgba(248, 249, 250, 0.8);
        padding: 25px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }
    
    .model-card h5 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.1em;
        font-weight: 600;
    }
    
    .model-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
    }
    
    .metric {
        text-align: center;
    }
    
    .metric-label {
        font-size: 0.8em;
        color: #666;
        margin-bottom: 5px;
    }
    
    .metric-value {
        font-size: 1.2em;
        font-weight: 600;
        color: #333;
    }
    
    .explanation-section {
        background: rgba(248, 249, 250, 0.8);
        padding: 25px;
        border-radius: 10px;
        margin: 20px 0;
    }
    
    .explanation-section h4 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2em;
    }
    
    .explanation-text {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.6;
        white-space: pre-line;
    }
    
    .feature-contributions {
        margin-top: 20px;
    }
    
    .feature-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    
    .feature-item {
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        border-left: 3px solid #667eea;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .feature-name {
        font-weight: 500;
        color: #333;
    }
    
    .feature-value {
        font-weight: 600;
        color: #667eea;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .loading-content {
        background: white;
        padding: 40px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .quick-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    /* History Section Styles */
    .history-section {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-top: 40px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .history-section h3 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: 600;
    }
    
    .history-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .history-controls select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
    }
    
    .history-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #f9f9f9;
    }
    
    .history-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
    }
    
    .history-item:hover {
        background-color: #f0f0f0;
    }
    
    .history-item:last-child {
        border-bottom: none;
    }
    
    .history-info {
        flex: 1;
    }
    
    .history-amount {
        font-weight: 600;
        font-size: 1.1em;
        color: #333;
    }
    
    .history-time {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
    }
    
    .history-prediction {
        text-align: right;
        margin-left: 20px;
    }
    
    .prediction-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .prediction-badge.fraud {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }
    
    .prediction-badge.legitimate {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }
    
    .history-probability {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
    }
    
    .history-loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-style: italic;
    }
    
    .history-empty {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .quick-btn {
        padding: 8px 16px;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
    }
    
    .quick-btn:hover {
        background: #667eea;
        color: white;
    }
    
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .prediction-summary {
            grid-template-columns: 1fr 1fr;
        }
        
        .model-details {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .quick-actions {
            flex-direction: column;
            align-items: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="prediction-container">
    <div class="form-container">
        <div class="form-header">
            <h2>üîç Advanced Transaction Fraud Check</h2>
            <p>Enter transaction details to analyze with our hybrid LSTM + Decision Tree model</p>
        </div>
        
        <form id="predictionForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="Amount">üí∞ Transaction Amount *</label>
                    <input type="number" id="Amount" name="Amount" step="0.01" placeholder="Enter amount" required>
                </div>
                
                <div class="form-group">
                    <label for="V1">V1 Feature</label>
                    <input type="number" id="V1" name="V1" step="0.000001" placeholder="V1 value">
                </div>
                
                <div class="form-group">
                    <label for="V2">V2 Feature</label>
                    <input type="number" id="V2" name="V2" step="0.000001" placeholder="V2 value">
                </div>
                
                <div class="form-group">
                    <label for="V3">V3 Feature</label>
                    <input type="number" id="V3" name="V3" step="0.000001" placeholder="V3 value">
                </div>
                
                <div class="form-group">
                    <label for="V4">V4 Feature</label>
                    <input type="number" id="V4" name="V4" step="0.000001" placeholder="V4 value">
                </div>
                
                <div class="form-group">
                    <label for="V5">V5 Feature</label>
                    <input type="number" id="V5" name="V5" step="0.000001" placeholder="V5 value">
                </div>
                
                <div class="form-group">
                    <label for="V6">V6 Feature</label>
                    <input type="number" id="V6" name="V6" step="0.000001" placeholder="V6 value">
                </div>
                
                <div class="form-group">
                    <label for="V7">V7 Feature</label>
                    <input type="number" id="V7" name="V7" step="0.000001" placeholder="V7 value">
                </div>
                
                <div class="form-group">
                    <label for="V8">V8 Feature</label>
                    <input type="number" id="V8" name="V8" step="0.000001" placeholder="V8 value">
                </div>
                
                <div class="form-group">
                    <label for="V9">V9 Feature</label>
                    <input type="number" id="V9" name="V9" step="0.000001" placeholder="V9 value">
                </div>
                
                <div class="form-group">
                    <label for="V10">V10 Feature</label>
                    <input type="number" id="V10" name="V10" step="0.000001" placeholder="V10 value">
                </div>
                
                <div class="form-group">
                    <label for="V11">V11 Feature</label>
                    <input type="number" id="V11" name="V11" step="0.000001" placeholder="V11 value">
                </div>
                
                <div class="form-group">
                    <label for="V12">V12 Feature</label>
                    <input type="number" id="V12" name="V12" step="0.000001" placeholder="V12 value">
                </div>
                
                <div class="form-group">
                    <label for="V13">V13 Feature</label>
                    <input type="number" id="V13" name="V13" step="0.000001" placeholder="V13 value">
                </div>
                
                <div class="form-group">
                    <label for="V14">V14 Feature</label>
                    <input type="number" id="V14" name="V14" step="0.000001" placeholder="V14 value">
                </div>
                
                <div class="form-group">
                    <label for="V15">V15 Feature</label>
                    <input type="number" id="V15" name="V15" step="0.000001" placeholder="V15 value">
                </div>
                
                <div class="form-group">
                    <label for="V16">V16 Feature</label>
                    <input type="number" id="V16" name="V16" step="0.000001" placeholder="V16 value">
                </div>
                
                <div class="form-group">
                    <label for="V17">V17 Feature</label>
                    <input type="number" id="V17" name="V17" step="0.000001" placeholder="V17 value">
                </div>
                
                <div class="form-group">
                    <label for="V18">V18 Feature</label>
                    <input type="number" id="V18" name="V18" step="0.000001" placeholder="V18 value">
                </div>
                
                <div class="form-group">
                    <label for="V19">V19 Feature</label>
                    <input type="number" id="V19" name="V19" step="0.000001" placeholder="V19 value">
                </div>
                
                <div class="form-group">
                    <label for="V20">V20 Feature</label>
                    <input type="number" id="V20" name="V20" step="0.000001" placeholder="V20 value">
                </div>
                
                <div class="form-group">
                    <label for="V21">V21 Feature</label>
                    <input type="number" id="V21" name="V21" step="0.000001" placeholder="V21 value">
                </div>
                
                <div class="form-group">
                    <label for="V22">V22 Feature</label>
                    <input type="number" id="V22" name="V22" step="0.000001" placeholder="V22 value">
                </div>
                
                <div class="form-group">
                    <label for="V23">V23 Feature</label>
                    <input type="number" id="V23" name="V23" step="0.000001" placeholder="V23 value">
                </div>
                
                <div class="form-group">
                    <label for="V24">V24 Feature</label>
                    <input type="number" id="V24" name="V24" step="0.000001" placeholder="V24 value">
                </div>
                
                <div class="form-group">
                    <label for="V25">V25 Feature</label>
                    <input type="number" id="V25" name="V25" step="0.000001" placeholder="V25 value">
                </div>
                
                <div class="form-group">
                    <label for="V26">V26 Feature</label>
                    <input type="number" id="V26" name="V26" step="0.000001" placeholder="V26 value">
                </div>
                
                <div class="form-group">
                    <label for="V27">V27 Feature</label>
                    <input type="number" id="V27" name="V27" step="0.000001" placeholder="V27 value">
                </div>
                
                <div class="form-group">
                    <label for="V28">V28 Feature</label>
                    <input type="number" id="V28" name="V28" step="0.000001" placeholder="V28 value">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="predictBtn">
                    üîç Analyze Transaction
                </button>
                
                <button type="button" class="btn btn-secondary" id="sampleBtn">
                    üìä Load Sample Data
                </button>
                
                <button type="button" class="btn btn-info" id="clearBtn">
                    üóëÔ∏è Clear Form
                </button>
            </div>
            
            <div class="quick-actions">
                <button type="button" class="quick-btn" onclick="loadSampleFraud()">Sample Fraud</button>
                <button type="button" class="quick-btn" onclick="loadSampleLegitimate()">Sample Legitimate</button>
                <button type="button" class="quick-btn" onclick="loadSampleHighRisk()">High Risk</button>
                <button type="button" class="quick-btn" onclick="loadSampleLowRisk()">Low Risk</button>
            </div>
        </form>
    </div>

    <div class="result-card" id="resultCard">
        <div class="result-header">
            <h3>üéØ Analysis Results</h3>
        </div>
        
        <div class="prediction-summary" id="predictionSummary">
            <!-- Dynamic content will be inserted here -->
        </div>
        
        <div class="probability-display">
            <h4>Fraud Probability</h4>
            <div class="probability-bar">
                <div class="probability-fill" id="probabilityFill" style="width: 0%"></div>
            </div>
            <div class="probability-labels">
                <span>0% (Safe)</span>
                <span id="probabilityText">0%</span>
                <span>100% (Fraud)</span>
            </div>
        </div>
        
        <div id="alertCard" class="alert-card" style="display: none;">
            <!-- Dynamic alert content -->
        </div>
        
        <div class="model-details" id="modelDetails">
            <!-- Dynamic model details -->
        </div>
        
        <div class="explanation-section" id="explanationSection" style="display: none;">
            <h4>üß† AI Explanation</h4>
            <div class="explanation-text" id="explanationText">
                <!-- Dynamic explanation -->
            </div>
        </div>
        
        <div class="feature-contributions" id="featureContributions" style="display: none;">
            <h4>üìä Feature Contributions</h4>
            <div class="feature-list" id="featureList">
                <!-- Dynamic feature contributions -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Analyzing Transaction...</h3>
        <p>Our hybrid model is processing your data</p>
    </div>
</div>
{% endblock %}

<!-- Transaction History Section -->
<div class="history-section">
    <h3>üìä Recent Transaction History</h3>
    <div class="history-controls">
        <button class="btn btn-info" onclick="loadHistory()">Refresh History</button>
        <select id="historyLimit" onchange="loadHistory()">
            <option value="10">Last 10</option>
            <option value="25" selected>Last 25</option>
            <option value="50">Last 50</option>
        </select>
    </div>
    <div class="history-list" id="historyList">
        <div class="history-loading">Loading transaction history...</div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('predictionForm');
    const resultCard = document.getElementById('resultCard');
    const predictBtn = document.getElementById('predictBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const clearBtn = document.getElementById('clearBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Sample data sets
    const sampleData = {
        fraud: {
            Amount: 2125.87,
            V1: -1.359807134,
            V2: -0.072781173,
            V3: 2.536346738,
            V4: 1.378155224,
            V5: -0.338261018,
            V6: 0.462387778,
            V7: 0.239598554,
            V8: 0.098697901,
            V9: 0.363786982,
            V10: 0.090794172,
            V11: -0.551599533,
            V12: -0.617800856,
            V13: -0.991389847,
            V14: -0.311169354,
            V15: 1.468176972,
            V16: -0.470400525,
            V17: 0.207971242,
            V18: 0.025790580,
            V19: 0.403992960,
            V20: 0.251412098,
            V21: -0.018306778,
            V22: 0.277837576,
            V23: -0.110473910,
            V24: 0.066928075,
            V25: 0.128539358,
            V26: -0.189114844,
            V27: 0.133558377,
            V28: -0.021053053
        },
        legitimate: {
            Amount: 149.62,
            V1: -0.072781173,
            V2: 0.066928075,
            V3: 0.128539358,
            V4: -0.189114844,
            V5: 0.133558377,
            V6: -0.021053053,
            V7: 0.277837576,
            V8: -0.110473910,
            V9: 0.066928075,
            V10: 0.128539358,
            V11: -0.189114844,
            V12: 0.133558377,
            V13: -0.021053053,
            V14: 0.277837576,
            V15: -0.110473910,
            V16: 0.066928075,
            V17: 0.128539358,
            V18: -0.189114844,
            V19: 0.133558377,
            V20: -0.021053053,
            V21: 0.277837576,
            V22: -0.110473910,
            V23: 0.066928075,
            V24: 0.128539358,
            V25: -0.189114844,
            V26: 0.133558377,
            V27: -0.021053053,
            V28: 0.277837576
        },
        highRisk: {
            Amount: 5000.00,
            V1: -2.5,
            V2: 1.8,
            V3: -3.2,
            V4: 2.1,
            V5: -1.9,
            V6: 2.8,
            V7: -2.3,
            V8: 1.7,
            V9: -2.9,
            V10: 2.4,
            V11: -3.1,
            V12: 1.6,
            V13: -2.7,
            V14: 2.2,
            V15: -2.8,
            V16: 1.9,
            V17: -2.6,
            V18: 2.0,
            V19: -2.4,
            V20: 1.8,
            V21: -2.9,
            V22: 2.1,
            V23: -2.5,
            V24: 1.7,
            V25: -2.8,
            V26: 2.3,
            V27: -2.2,
            V28: 1.9
        },
        lowRisk: {
            Amount: 25.50,
            V1: 0.1,
            V2: -0.2,
            V3: 0.3,
            V4: -0.1,
            V5: 0.2,
            V6: -0.3,
            V7: 0.1,
            V8: -0.2,
            V9: 0.3,
            V10: -0.1,
            V11: 0.2,
            V12: -0.3,
            V13: 0.1,
            V14: -0.2,
            V15: 0.3,
            V16: -0.1,
            V17: 0.2,
            V18: -0.3,
            V19: 0.1,
            V20: -0.2,
            V21: 0.3,
            V22: -0.1,
            V23: 0.2,
            V24: -0.3,
            V25: 0.1,
            V26: -0.2,
            V27: 0.3,
            V28: -0.1
        }
    };
    
    // Load sample data functions
    function loadSampleData(type) {
        const data = sampleData[type];
        if (!data) return;
        
        for (const [key, value] of Object.entries(data)) {
            const input = document.getElementById(key);
            if (input) {
                input.value = value;
            }
        }
        
        // Show success message
        showNotification(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} sample data loaded!`, 'success');
    }
    
    // Global functions for quick actions
    window.loadSampleFraud = () => loadSampleData('fraud');
    window.loadSampleLegitimate = () => loadSampleData('legitimate');
    window.loadSampleHighRisk = () => loadSampleData('highRisk');
    window.loadSampleLowRisk = () => loadSampleData('lowRisk');
    
    // Clear form
    clearBtn.addEventListener('click', function() {
        form.reset();
        resultCard.style.display = 'none';
        showNotification('üóëÔ∏è Form cleared!', 'info');
    });
    
    // Load sample data
    sampleBtn.addEventListener('click', function() {
        loadSampleData('legitimate');
    });
    
    // Load transaction history on page load
    loadHistory();
    
    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading
        showLoading(true);
        
        try {
            const formData = new FormData(form);
            const transactionData = {};
            
            // Convert form data to object
            for (const [key, value] of formData.entries()) {
                if (value && value.trim() !== '') {
                    transactionData[key] = parseFloat(value);
                }
            }
            
            console.log('Submitting transaction data:', transactionData);
            
            // Make prediction request
            const response = await fetch('/api/v1/predict/hybrid/single?with_explanation=true', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(transactionData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('Prediction result:', result);
            
            if (result.success) {
                displayResult(result.prediction);
            } else {
                throw new Error(result.error || 'Unknown error occurred');
            }
            
        } catch (error) {
            console.error('Prediction error:', error);
            showNotification('‚ùå Error: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    });
    
    function displayResult(prediction) {
        resultCard.style.display = 'block';
        
        // Update prediction summary
        const summary = document.getElementById('predictionSummary');
        const isFraud = prediction.prediction === 1;
        const probability = (prediction.probability * 100).toFixed(1);
        
        summary.innerHTML = `
            <div class="summary-card">
                <h4>Prediction</h4>
                <div class="summary-value ${isFraud ? 'fraud' : 'safe'}">
                    ${isFraud ? 'FRAUD' : 'SAFE'}
                </div>
            </div>
            <div class="summary-card">
                <h4>Probability</h4>
                <div class="summary-value">${probability}%</div>
            </div>
            <div class="summary-card">
                <h4>Dominant Model</h4>
                <div class="summary-value">${prediction.dominant_model || 'Hybrid'}</div>
            </div>
            <div class="summary-card">
                <h4>Alpha Used</h4>
                <div class="summary-value">${(prediction.alpha_used || 0.6).toFixed(2)}</div>
            </div>
        `;
        
        // Update probability bar
        document.getElementById('probabilityFill').style.width = probability + '%';
        document.getElementById('probabilityText').textContent = probability + '%';
        
        // Show appropriate alert
        const alertCard = document.getElementById('alertCard');
        if (isFraud) {
            alertCard.className = 'alert-card fraud';
            alertCard.innerHTML = `
                <h4>üö® FRAUD DETECTED!</h4>
                <p>This transaction shows strong indicators of fraudulent activity. Please review immediately.</p>
            `;
        } else {
            alertCard.className = 'alert-card safe';
            alertCard.innerHTML = `
                <h4>‚úÖ Transaction Appears Legitimate</h4>
                <p>This transaction shows normal patterns and appears to be legitimate.</p>
            `;
        }
        alertCard.style.display = 'block';
        
        // Show model details
        const modelDetails = document.getElementById('modelDetails');
        modelDetails.innerHTML = `
            <div class="model-card">
                <h5>LSTM Neural Network</h5>
                <div class="model-metrics">
                    <div class="metric">
                        <div class="metric-label">Confidence</div>
                        <div class="metric-value">${((prediction.lstm_probability || 0) * 100).toFixed(1)}%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Verdict</div>
                        <div class="metric-value">${(prediction.lstm_probability || 0) >= 0.5 ? 'FRAUD' : 'SAFE'}</div>
                    </div>
                </div>
            </div>
            <div class="model-card">
                <h5>Decision Tree</h5>
                <div class="model-metrics">
                    <div class="metric">
                        <div class="metric-label">Confidence</div>
                        <div class="metric-value">${((prediction.dt_probability || 0) * 100).toFixed(1)}%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Verdict</div>
                        <div class="metric-value">${(prediction.dt_probability || 0) >= 0.5 ? 'FRAUD' : 'SAFE'}</div>
                    </div>
                </div>
            </div>
        `;
        
        // Show explanation if available
        if (prediction.explanation) {
            document.getElementById('explanationText').textContent = prediction.explanation;
            document.getElementById('explanationSection').style.display = 'block';
        }
        
        // Show feature contributions if available
        if (prediction.feature_contributions && prediction.feature_contributions.length > 0) {
            const featureList = document.getElementById('featureList');
            featureList.innerHTML = prediction.feature_contributions.map(([feature, value]) => `
                <div class="feature-item">
                    <span class="feature-name">${feature}</span>
                    <span class="feature-value">${value.toFixed(4)}</span>
                </div>
            `).join('');
            document.getElementById('featureContributions').style.display = 'block';
        }
        
        // Scroll to results
        resultCard.scrollIntoView({ behavior: 'smooth' });
    }
    
    function showLoading(show) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        `;
        
        // Set background color based on type
        const colors = {
            success: '#27ae60',
            error: '#e74c3c',
            info: '#3498db',
            warning: '#f39c12'
        };
        notification.style.backgroundColor = colors[type] || colors.info;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // Add CSS for notifications
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
});

// Load transaction history
async function loadHistory() {
    const historyList = document.getElementById('historyList');
    const limit = document.getElementById('historyLimit').value;
    
    try {
        historyList.innerHTML = '<div class="history-loading">Loading transaction history...</div>';
        
        const response = await fetch(`/api/v1/predict/hybrid/history?limit=${limit}`);
        const data = await response.json();
        
        if (data.success && data.transactions.length > 0) {
            displayHistory(data.transactions);
        } else {
            historyList.innerHTML = '<div class="history-empty">No transaction history found. Make some predictions to see them here!</div>';
        }
    } catch (error) {
        console.error('Failed to load history:', error);
        historyList.innerHTML = '<div class="history-empty">Failed to load transaction history.</div>';
    }
}

// Display transaction history
function displayHistory(transactions) {
    const historyList = document.getElementById('historyList');
    
    const historyHTML = transactions.map(transaction => {
        const isFraud = transaction.prediction === 1;
        const amount = transaction.transaction_data.Amount || 'N/A';
        const time = new Date(transaction.timestamp).toLocaleString();
        const probability = (transaction.probability * 100).toFixed(1);
        
        return `
            <div class="history-item">
                <div class="history-info">
                    <div class="history-amount">$${amount}</div>
                    <div class="history-time">${time}</div>
                </div>
                <div class="history-prediction">
                    <div class="prediction-badge ${isFraud ? 'fraud' : 'legitimate'}">
                        ${isFraud ? 'FRAUD' : 'LEGITIMATE'}
                    </div>
                    <div class="history-probability">${probability}% confidence</div>
                </div>
            </div>
        `;
    }).join('');
    
    historyList.innerHTML = historyHTML;
}

// Global function for history refresh button
window.loadHistory = loadHistory;
</script>
{% endblock %}